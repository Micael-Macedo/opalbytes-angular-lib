name: Publish Libs
on:
  push:
    branches: [ main ]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  check-commits:
    runs-on: ubuntu-latest
    outputs:
      should-release-libs: ${{ steps.check.outputs.should-release-libs }}
      should-release-components: ${{ steps.check.outputs.should-release-components }}
      should-release-directives: ${{ steps.check.outputs.should-release-directives }}
      should-release-services: ${{ steps.check.outputs.should-release-services }}
      should-release-utils: ${{ steps.check.outputs.should-release-utils }}
      should-release-core: ${{ steps.check.outputs.should-release-core }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check commits for library changes
        id: check
        run: |
          # Obter todos os commits deste push
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            COMMITS=$(git log --pretty=format:"%s" ${{ github.event.before }}..${{ github.event.after }})
          else
            # Primeiro push para o branch
            COMMITS=$(git log --pretty=format:"%s" ${{ github.event.after }})
          fi
          
          echo "Commits encontrados:"
          echo "$COMMITS"
          
          # Verificar cada commit para cada biblioteca
          should_release_libs="false"
          should_release_components="false"
          should_release_directives="false"
          should_release_services="false"
          should_release_utils="false"
          should_release_core="false"
          
          while IFS= read -r commit_message; do
            echo "Analisando commit: $commit_message"
            
            # Verificar padrões para cada biblioteca
            if [[ "$commit_message" =~ (feat\(libs\)|fix\(libs\)|refactor\(libs\)|docs\(libs\)|chore\(libs\)|release\(libs\)|test\(libs\)|style\(libs\)|feature\(libs\)) ]]; then
              should_release_libs="true"
              echo "Commit relacionado a libs encontrado"
            fi
            
            if [[ "$commit_message" =~ (feat\(components\)|fix\(components\)|refactor\(components\)|docs\(components\)|chore\(components\)|release\(components\)|test\(components\)|style\(components\)|feature\(components\)) ]]; then
              should_release_components="true"
              echo "Commit relacionado a components encontrado"
            fi
            
            if [[ "$commit_message" =~ (feat\(directives\)|fix\(directives\)|refactor\(directives\)|docs\(directives\)|chore\(directives\)|release\(directives\)|test\(directives\)|style\(directives\)|feature\(directives\)) ]]; then
              should_release_directives="true"
              echo "Commit relacionado a directives encontrado"
            fi
            
            if [[ "$commit_message" =~ (feat\(services\)|fix\(services\)|refactor\(services\)|docs\(services\)|chore\(services\)|release\(services\)|test\(services\)|style\(services\)|feature\(services\)) ]]; then
              should_release_services="true"
              echo "Commit relacionado a services encontrado"
            fi
            
            if [[ "$commit_message" =~ (feat\(utils\)|fix\(utils\)|refactor\(utils\)|docs\(utils\)|chore\(utils\)|release\(utils\)|test\(utils\)|style\(utils\)|feature\(utils\)) ]]; then
              should_release_utils="true"
              echo "Commit relacionado a utils encontrado"
            fi
            
            if [[ "$commit_message" =~ (feat\(core\)|fix\(core\)|refactor\(core\)|docs\(core\)|chore\(core\)|release\(core\)|test\(core\)|style\(core\)|feature\(core\)) ]]; then
              should_release_core="true"
              echo "Commit relacionado a core encontrado"
            fi
          done <<< "$COMMITS"
          
          # Export results
          echo "should-release-libs=$should_release_libs" >> $GITHUB_OUTPUT
          echo "should-release-components=$should_release_components" >> $GITHUB_OUTPUT
          echo "should-release-directives=$should_release_directives" >> $GITHUB_OUTPUT
          echo "should-release-services=$should_release_services" >> $GITHUB_OUTPUT
          echo "should-release-utils=$should_release_utils" >> $GITHUB_OUTPUT
          echo "should-release-core=$should_release_core" >> $GITHUB_OUTPUT

  # Primeira biblioteca - ordem pode ser ajustada conforme suas dependências
  release-core:
    runs-on: ubuntu-latest
    needs: check-commits
    if: needs.check-commits.outputs.should-release-core == 'true'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure npm authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc

      - name: Install dependencies
        run: npm ci

      - name: Lint lib
        run: npm run lint
        
      - name: Build library
        run: npm run build:core

      - name: Release Core
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: cd projects/ngx-opalbytes-core-shared && npx semantic-release

  release-utils:
    runs-on: ubuntu-latest
    needs: [check-commits, release-core]
    if: needs.check-commits.outputs.should-release-utils == 'true'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure npm authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc

      - name: Install dependencies
        run: npm ci

      - name: Lint lib
        run: npm run lint
        
      - name: Test lib
        run: npm run test:utils

      - name: Build library
        run: npm run build:utils

      - name: Release Utils
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: cd projects/ngx-opalbytes-utils && npx semantic-release

  release-services:
    runs-on: ubuntu-latest
    needs: [check-commits, release-utils]
    if: needs.check-commits.outputs.should-release-services == 'true'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure npm authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc

      - name: Install dependencies
        run: npm ci

      - name: Lint lib
        run: npm run lint

      - name: Test lib
        run: npm run test:services

      - name: Build library
        run: npm run build:services

      - name: Release Services
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: cd projects/ngx-opalbytes-services && npx semantic-release

  release-directives:
    runs-on: ubuntu-latest
    needs: [check-commits, release-services]
    if: needs.check-commits.outputs.should-release-directives == 'true'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure npm authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc

      - name: Install dependencies
        run: npm ci

      - name: Lint lib
        run: npm run lint

      - name: Test lib
        run: npm run test:directives

      - name: Build library
        run: npm run build:directives

      - name: Release Directives
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: cd projects/ngx-opalbytes-directives && npx semantic-release

  release-components:
    runs-on: ubuntu-latest
    needs: [check-commits, release-directives]
    if: needs.check-commits.outputs.should-release-components == 'true'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure npm authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc

      - name: Install dependencies
        run: npm ci

      - name: Lint lib
        run: npm run lint

      - name: Test lib
        run: npm run test:components

      - name: Build library
        run: npm run build:components

      - name: Release Components
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: cd projects/ngx-opalbytes-components && npx semantic-release

  release-libs:
    runs-on: ubuntu-latest
    needs: [check-commits, release-components]
    if: needs.check-commits.outputs.should-release-libs == 'true'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
          registry-url: 'https://registry.npmjs.org'

      - name: Configure npm authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc

      - name: Install dependencies
        run: npm ci
          
      - name: Lint lib
        run: npm run lint

      - name: Release Libs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npx semantic-release