name: Publish Libs Sequentially
on:
  push:
    branches: [ main ]

permissions:
  contents: write
  issues: write
  pull-requests: write
  id-token: write

jobs:
  check-commits:
    runs-on: ubuntu-latest
    outputs:
      should-release-libs: ${{ steps.check.outputs.should-release-libs }}
      should-release-components: ${{ steps.check.outputs.should-release-components }}
      should-release-directives: ${{ steps.check.outputs.should-release-directives }}
      should-release-services: ${{ steps.check.outputs.should-release-services }}
      should-release-utils: ${{ steps.check.outputs.should-release-utils }}
      should-release-core: ${{ steps.check.outputs.should-release-core }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Check commits for library changes
        id: check
        run: |
          # Obter todos os commits deste push
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            COMMITS=$(git log --pretty=format:"%s" ${{ github.event.before }}..${{ github.event.after }})
          else
            # Primeiro push para o branch
            COMMITS=$(git log --pretty=format:"%s" ${{ github.event.after }})
          fi
          
          echo "Commits encontrados:"
          echo "$COMMITS"
          
          # Verificar cada commit para cada biblioteca
          should_release_libs="false"
          should_release_components="false"
          should_release_directives="false"
          should_release_services="false"
          should_release_utils="false"
          should_release_core="false"
          
          while IFS= read -r commit_message; do
            echo "Analisando commit: $commit_message"
            
            # Verificar padr√µes para cada biblioteca
            if [[ "$commit_message" =~ (feat\(libs\)|fix\(libs\)|refactor\(libs\)|docs\(libs\)|chore\(libs\)|release\(libs\)|test\(libs\)|style\(libs\)|feature\(libs\)) ]]; then
              should_release_libs="true"
              echo "Commit relacionado a libs encontrado"
            fi
            
            if [[ "$commit_message" =~ (feat\(components\)|fix\(components\)|refactor\(components\)|docs\(components\)|chore\(components\)|release\(components\)|test\(components\)|style\(components\)|feature\(components\)) ]]; then
              should_release_components="true"
              echo "Commit relacionado a components encontrado"
            fi
            
            if [[ "$commit_message" =~ (feat\(directives\)|fix\(directives\)|refactor\(directives\)|docs\(directives\)|chore\(directives\)|release\(directives\)|test\(directives\)|style\(directives\)|feature\(directives\)) ]]; then
              should_release_directives="true"
              echo "Commit relacionado a directives encontrado"
            fi
            
            if [[ "$commit_message" =~ (feat\(services\)|fix\(services\)|refactor\(services\)|docs\(services\)|chore\(services\)|release\(services\)|test\(services\)|style\(services\)|feature\(services\)) ]]; then
              should_release_services="true"
              echo "Commit relacionado a services encontrado"
            fi
            
            if [[ "$commit_message" =~ (feat\(utils\)|fix\(utils\)|refactor\(utils\)|docs\(utils\)|chore\(utils\)|release\(utils\)|test\(utils\)|style\(utils\)|feature\(utils\)) ]]; then
              should_release_utils="true"
              echo "Commit relacionado a utils encontrado"
            fi
            
            if [[ "$commit_message" =~ (feat\(core\)|fix\(core\)|refactor\(core\)|docs\(core\)|chore\(core\)|release\(core\)|test\(core\)|style\(core\)|feature\(core\)) ]]; then
              should_release_core="true"
              echo "Commit relacionado a core encontrado"
            fi
          done <<< "$COMMITS"
          
          # Export results
          echo "should-release-libs=$should_release_libs" >> $GITHUB_OUTPUT
          echo "should-release-components=$should_release_components" >> $GITHUB_OUTPUT
          echo "should-release-directives=$should_release_directives" >> $GITHUB_OUTPUT
          echo "should-release-services=$should_release_services" >> $GITHUB_OUTPUT
          echo "should-release-utils=$should_release_utils" >> $GITHUB_OUTPUT
          echo "should-release-core=$should_release_core" >> $GITHUB_OUTPUT

  publish-sequentially:
    runs-on: ubuntu-latest
    needs: check-commits
    if: |
      needs.check-commits.outputs.should-release-core == 'true' ||
      needs.check-commits.outputs.should-release-utils == 'true' ||
      needs.check-commits.outputs.should-release-services == 'true' ||
      needs.check-commits.outputs.should-release-directives == 'true' ||
      needs.check-commits.outputs.should-release-components == 'true' ||
      needs.check-commits.outputs.should-release-libs == 'true'
    
    strategy:
      max-parallel: 1  # ‚¨ÖÔ∏è GARANTE EXECU√á√ÉO SEQUENCIAL - UMA POR VEZ!
      fail-fast: false  # Se uma falhar, continua com as outras
      matrix:
        # ORDEM DE EXECU√á√ÉO - IMPORTANTE: coloque na ordem das depend√™ncias
        # Primeiro as bibliotecas base, depois as que dependem delas
        library: ['core', 'utils', 'services', 'directives', 'components', 'libs']
        include:
          # CORE - biblioteca base
          - library: 'core'
            condition: ${{ needs.check-commits.outputs.should-release-core }}
            project-path: 'projects/ngx-opalbytes-core-shared'
            build-command: 'npm run build:core'
            test-command: 'echo "No tests for core"'
            release-command: 'cd projects/ngx-opalbytes-core-shared && npx semantic-release'
          
          # UTILS
          - library: 'utils'
            condition: ${{ needs.check-commits.outputs.should-release-utils }}
            project-path: 'projects/ngx-opalbytes-utils'
            build-command: 'npm run build:utils'
            test-command: 'npm run test:utils'
            release-command: 'cd projects/ngx-opalbytes-utils && npx semantic-release'
          
          # SERVICES
          - library: 'services'
            condition: ${{ needs.check-commits.outputs.should-release-services }}
            project-path: 'projects/ngx-opalbytes-services'
            build-command: 'npm run build:services'
            test-command: 'npm run test:services'
            release-command: 'cd projects/ngx-opalbytes-services && npx semantic-release'
          
          # DIRECTIVES
          - library: 'directives'
            condition: ${{ needs.check-commits.outputs.should-release-directives }}
            project-path: 'projects/ngx-opalbytes-directives'
            build-command: 'npm run build:directives'
            test-command: 'npm run test:directives'
            release-command: 'cd projects/ngx-opalbytes-directives && npx semantic-release'
          
          # COMPONENTS
          - library: 'components'
            condition: ${{ needs.check-commits.outputs.should-release-components }}
            project-path: 'projects/ngx-opalbytes-components'
            build-command: 'npm run build:components'
            test-command: 'npm run test:components'
            release-command: 'cd projects/ngx-opalbytes-components && npx semantic-release'
          
          # LIBS (raiz)
          - library: 'libs'
            condition: ${{ needs.check-commits.outputs.should-release-libs }}
            project-path: '.'
            build-command: 'echo "No build needed for root"'
            test-command: 'echo "No tests for root"'
            release-command: 'npx semantic-release'
    
    steps:
      - name: Iniciar processo para ${{ matrix.library }}
        run: |
          echo "========================================"
          echo "üì¶ PROCESSANDO: ${{ matrix.library }}"
          echo "üìä Condi√ß√£o para release: ${{ matrix.condition }}"
          echo "üìÅ Caminho do projeto: ${{ matrix.project-path }}"
          echo "========================================"
      
      - name: Pular biblioteca se n√£o houver mudan√ßas
        if: matrix.condition != 'true'
        run: |
          echo "‚è≠Ô∏è  PULANDO ${{ matrix.library }} - nenhuma mudan√ßa detectada nos commits"
          echo "‚úÖ Pr√≥xima biblioteca na sequ√™ncia..."
          exit 0
      
      - uses: actions/checkout@v3
        if: matrix.condition == 'true'
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        if: matrix.condition == 'true'
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Configure npm authentication
        if: matrix.condition == 'true'
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "registry=https://registry.npmjs.org/" >> ~/.npmrc
          echo "always-auth=true" >> ~/.npmrc

      - name: Install dependencies
        if: matrix.condition == 'true'
        run: |
          echo "üì• Instalando depend√™ncias..."
          npm ci --no-audit --prefer-offline
          echo "‚úÖ Depend√™ncias instaladas"
          
      - name: Verify Git configuration
        if: matrix.condition == 'true'
        run: |
          echo "üîç Verificando configura√ß√£o do Git..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git remote -v
          
      - name: Lint ${{ matrix.library }}
        if: matrix.condition == 'true'
        run: |
          echo "üîç Executando lint..."
          npm run lint
          echo "‚úÖ Lint conclu√≠do"

      - name: Test ${{ matrix.library }}
        if: matrix.condition == 'true' && matrix.test-command != 'echo "No tests for root"'
        run: |
          echo "üß™ Executando testes..."
          ${{ matrix.test-command }}
          echo "‚úÖ Testes conclu√≠dos"

      - name: Build ${{ matrix.library }}
        if: matrix.condition == 'true' && matrix.build-command != 'echo "No build needed for root"'
        run: |
          echo "üèóÔ∏è  Construindo biblioteca..."
          ${{ matrix.build-command }}
          echo "‚úÖ Build conclu√≠do"

      - name: Release ${{ matrix.library }}
        if: matrix.condition == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üöÄ INICIANDO RELEASE: ${{ matrix.library }}"
          echo "üìÅ Diret√≥rio: $(pwd)"
          echo "üì¶ Comando: ${{ matrix.release-command }}"
          
          # Executar semantic-release
          ${{ matrix.release-command }}
          
          echo "‚úÖ RELEASE CONCLU√çDO: ${{ matrix.library }}"
          echo "========================================"